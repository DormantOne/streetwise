
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>JAA Home Health Help Finder</title>

  <style>
    :root{
      --bg: #f8fafc;
      --panel: #ffffff;
      --panel2: #f1f5f9;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #0284c7;
      --accent2: #7c3aed;
      --warn: #d97706;
      --good: #059669;
      --meh: #d97706;
      --bad: #e11d48;
      --stroke: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 18px;
      --radius2: 14px;
      --maxw: 920px;
      --tap: 52px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(800px 800px at 10% 10%, rgba(14, 165, 233, 0.08), transparent 50%),
        radial-gradient(800px 800px at 90% 90%, rgba(124, 58, 237, 0.08), transparent 50%),
        var(--bg);
      color: var(--text);
      min-height:100vh;
    }

    .wrap{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    /* ===== Hope Banner Animation ===== */
    .hope-banner{
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 26px;
      padding: 18px 16px 16px;
      background: linear-gradient(135deg, #0f172a, #1e1b4b);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
      margin-bottom: 14px;
      color: #f8fafc;
    }

    .hope-title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }

    .hope-title h1{
      margin:0;
      font-size: 1.28rem;
      letter-spacing: .2px;
      line-height: 1.2;
      color: #fff;
    }
    .hope-title p{
      margin:6px 0 0;
      color: #cbd5e1;
      font-size: .95rem;
      line-height: 1.35;
    }

    .badge{
      flex:0 0 auto;
      font-family: var(--mono);
      font-size: .78rem;
      color: #fff;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.1);
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      white-space: nowrap;
    }

    .aurora{
      position:absolute;
      inset:-40px;
      background:
        radial-gradient(520px 280px at 12% 20%, rgba(103,232,249,.28), transparent 60%),
        radial-gradient(460px 240px at 88% 25%, rgba(167,139,250,.26), transparent 58%),
        radial-gradient(520px 260px at 40% 90%, rgba(251,191,36,.18), transparent 58%);
      filter: blur(18px);
      opacity: .9;
      animation: drift 11s ease-in-out infinite alternate;
      pointer-events:none;
    }

    @keyframes drift{
      from{ transform: translate3d(-18px, -8px, 0) scale(1.04); }
      to  { transform: translate3d(18px, 10px, 0) scale(1.06); }
    }

    .lights{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:.85;
      mask-image: radial-gradient(circle at 50% 40%, rgba(0,0,0,1), rgba(0,0,0,.1) 55%, transparent 78%);
      -webkit-mask-image: radial-gradient(circle at 50% 40%, rgba(0,0,0,1), rgba(0,0,0,.1) 55%, transparent 78%);
    }

    .light{
      position:absolute;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.4);
      box-shadow: 0 0 22px rgba(103,232,249,.5);
      animation: floatUp 7s linear infinite;
    }

    @keyframes floatUp{
      from{ transform: translate3d(0, 40px, 0); opacity:0; }
      10%{ opacity:.7; }
      70%{ opacity:.5; }
      to{ transform: translate3d(0, -220px, 0); opacity:0; }
    }

    /* ===== Audience Tabs (Patients / Staff / Admin) ===== */
    .tabs{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .tab{
      height: 42px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: #e2e8f0;
      font-weight: 800;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap: 8px;
      transition: transform .08s ease;
    }
    .tab:active{ transform: scale(0.98); }
    .tab.active{
      background: rgba(255,255,255,.22);
      border-color: rgba(255,255,255,.35);
      color: #ffffff;
    }
    .tab small{
      font-weight: 700;
      opacity: .85;
    }

    /* Admin only indicator (subtle) */
    .admin-pill{
      margin-left: auto;
      font-family: var(--mono);
      font-size: .76rem;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.85);
      display:none;
      white-space: nowrap;
    }
    body.admin-on .admin-pill{ display:inline-flex; }

    .share-link {
      cursor: pointer;
      font-size: 0.85rem;
      text-decoration: underline;
      color: rgba(255,255,255,0.85);
      margin-top: 6px;
      display:inline-block;
    }

    .muted-note{
      color: rgba(255,255,255,.7);
      font-size: .9rem;
      line-height: 1.35;
      margin: 10px 0 0;
    }

    /* ===== Icon Navigation ===== */
    .icon-nav {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .icon-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      padding: 16px 6px;
      cursor: pointer;
      text-align: center;
      user-select: none;
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
      color: var(--text);
      position: relative;
      overflow: hidden;
    }

    .icon-btn:active {
      transform: scale(0.96);
      background: var(--panel2);
    }

    .icon-btn-emoji {
      font-size: 2.2rem;
      margin-bottom: 8px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.15));
    }

    .icon-btn-label {
      font-size: 0.8rem;
      font-weight: 700;
      line-height: 1.1;
      opacity: 0.9;
    }

    @media (min-width: 600px) {
      .icon-nav { grid-template-columns: repeat(5, 1fr); }
    }

    /* ===== Primary Call Card ===== */
    .primary{
      margin-top: 14px;
      display:grid;
      gap: 10px;
    }

    .card{
      border: 1px solid var(--stroke);
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-inner{
      padding: 14px 14px 12px;
    }

    .callbox{
      display:flex;
      gap: 12px;
      align-items: stretch;
    }

    .call-left{
      flex: 1 1 auto;
      min-width: 0;
    }

    .label{
      color: var(--muted);
      font-size: .82rem;
      letter-spacing:.2px;
      font-weight: 600;
    }

    .big-name{
      margin: 5px 0 4px;
      font-size: 1.05rem;
      font-weight: 720;
      line-height:1.25;
      color: var(--text);
    }

    .small{
      color: var(--muted);
      font-size: .92rem;
      line-height: 1.35;
      margin: 0;
    }

    .call-btn{
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      min-width: 150px;
      padding: 0 14px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.05);
      background: linear-gradient(135deg, #e0f2fe, #f3e8ff);
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
      text-decoration:none;
      color: var(--accent);
      height: var(--tap);
      font-weight: 750;
      letter-spacing:.2px;
      gap: 10px;
      white-space: nowrap;
      user-select:none;
    }
    .call-btn:active{ transform: translateY(1px); }

    .call-btn span{
      display:inline-block;
      font-family: var(--mono);
      font-size: .98rem;
    }

    .pill-row{
      margin-top: 10px;
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pill{
      font-size:.78rem;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--panel2);
      color: var(--muted);
      font-weight: 600;
    }

    /* ===== Section List ===== */
    .section{
      margin-top: 14px;
      scroll-margin-top: 20px;
    }

    .section h2{
      margin: 16px 2px 10px;
      font-size: 1.05rem;
      letter-spacing:.2px;
    }

    .item{
      margin: 10px 0;
      border-top: 1px solid var(--stroke);
    }

    .item:first-child{ border-top:none; }

    .item-head{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:space-between;
      padding: 12px 14px;
    }

    .item-title{
      margin:0;
      font-size: .98rem;
      font-weight: 720;
      line-height: 1.2;
    }
    .item-meta{
      margin-top: 6px;
      color: var(--muted);
      font-size: .88rem;
      line-height: 1.35;
    }

    .item-actions{
      flex:0 0 auto;
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: wrap;
    }

    .mini-btn{
      height: 44px;
      padding: 0 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: var(--panel2);
      color: var(--text);
      text-decoration:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      user-select:none;
      white-space: nowrap;
      font-weight: 700;
      font-size: .88rem;
    }
    .mini-btn:active{ transform: translateY(1px); }

    .mini-btn.primary{
      background: linear-gradient(135deg, #e0f2fe, #f3e8ff);
      border-color: rgba(0,0,0,.05);
      color: var(--accent);
    }

    .mini-btn.web{
      background: #ffffff;
      border-color: rgba(2,132,199,.25);
      color: var(--accent);
    }

    details{
      padding: 0 14px 12px;
    }
    details summary{
      cursor:pointer;
      list-style:none;
      color: var(--accent);
      font-weight: 750;
      margin-top: 0;
      user-select:none;
    }
    details summary::-webkit-details-marker{ display:none; }

    .details-box{
      margin-top: 10px;
      border-radius: var(--radius2);
      border: 1px solid var(--stroke);
      background: var(--panel2);
      padding: 10px 12px;
      color: var(--text);
      line-height: 1.4;
      font-size: .92rem;
      white-space: pre-wrap;
    }

    .details-box a{
      color: var(--accent);
      font-weight: 700;
      text-decoration: underline;
      word-break: break-word;
    }

    /* ===== Admin Panels (ONLY visible in Admin mode) ===== */
    .admin-panel{
      display:none;
      margin-top: 12px;
      border-radius: var(--radius2);
      border: 1px dashed rgba(2,132,199,.45);
      background: #ffffff;
      padding: 12px;
    }
    body.admin-on .admin-panel{ display:block; }

    .admin-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .admin-title strong{
      font-size: .92rem;
      color: var(--text);
    }
    .admin-title span{
      font-family: var(--mono);
      font-size: .75rem;
      color: var(--muted);
      white-space: nowrap;
    }

    .admin-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 640px){
      .admin-grid{ grid-template-columns: 1fr 1fr; }
    }

    .chk{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid var(--stroke);
      border-radius: 14px;
      background: var(--panel2);
      font-weight: 750;
      color: var(--text);
      user-select:none;
    }
    .chk input{ width: 18px; height: 18px; }

    .admin-comment{
      grid-column: 1 / -1;
    }
    .admin-comment textarea{
      min-height: 70px;
    }

    .admin-footer{
      display:none;
      margin-top: 14px;
    }
    body.admin-on .admin-footer{ display:block; }

    .admin-actions-row{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      margin-top: 10px;
    }

    .ghost-btn{
      height: 46px;
      padding: 0 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: #ffffff;
      color: var(--muted);
      font-weight: 800;
      cursor:pointer;
      user-select:none;
    }
    .ghost-btn:active{ transform: translateY(1px); }

    .admin-status{
      font-family: var(--mono);
      font-size: .78rem;
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--panel2);
    }

    /* ===== Footer Feedback ===== */
    .feedback{
      margin-top: 18px;
    }
    .feedback h3{
      margin:0;
      font-size: 1.0rem;
    }
    .feedback p{
      margin: 6px 0 10px;
      color: var(--muted);
      font-size:.92rem;
      line-height:1.35;
    }

    .rate-row{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
    }

    .rate-btn{
      flex: 1 1 140px;
      height: var(--tap);
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: var(--panel2);
      color: var(--text);
      font-weight: 800;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,.05);
    }
    .rate-btn.good{ background: #dcfce7; border-color: #86efac; color: #166534; }
    .rate-btn.meh{  background: #fef3c7; border-color: #fcd34d; color: #92400e; }
    .rate-btn.bad{  background: #ffe4e6; border-color: #fda4af; color: #9f1239; }
    .rate-btn:active{ transform: translateY(1px); }

    .why{
      margin-top: 10px;
      display:none;
      gap: 10px;
    }

    textarea{
      width:100%;
      min-height: 88px;
      resize: vertical;
      border-radius: 16px;
      padding: 12px;
      border: 1px solid var(--stroke);
      background: var(--bg);
      color: var(--text);
      font-size: .95rem;
      line-height: 1.35;
      outline:none;
    }
    textarea::placeholder{ color: var(--muted); }

    .send-row{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      margin-top: 10px;
    }

    .send-btn{
      height: var(--tap);
      padding: 0 14px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.05);
      background: linear-gradient(135deg, #e0f2fe, #f3e8ff);
      color: var(--accent);
      font-weight: 850;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
    }
    .send-btn:active{ transform: translateY(1px); }

    .fineprint{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: .82rem;
      line-height: 1.35;
    }

    /* ===== QR Code Modal ===== */
    .qr-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      backdrop-filter: blur(5px);
    }
    .qr-modal.active { display: flex; }

    .qr-card {
      background: white;
      padding: 30px;
      border-radius: 24px;
      text-align: center;
      max-width: 340px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }
    .qr-card h3 { margin: 0 0 15px; color: #0f172a; }
    .qr-card img { width: 100%; height: auto; border-radius: 8px; }
    .qr-close {
      margin-top: 20px;
      width: 100%;
      height: 48px;
      background: #e2e8f0;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      color: #334155;
      cursor: pointer;
    }

    /* ===== Utilities ===== */
    .tiny{
      font-size:.8rem;
      color: var(--muted);
      font-family: var(--mono);
    }

    @media (max-width: 520px){
      .callbox{ flex-direction: column; }
      .call-btn{ width: 100%; min-width: 0; }
      .item-head{ flex-direction: column; align-items: stretch; }
      .item-actions{ justify-content:flex-start; }
      .mini-btn{ flex: 1 1 auto; }
      .admin-pill{ margin-left: 0; width: 100%; justify-content:center; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hope-banner">
      <div class="aurora"></div>
      <div class="lights" id="lights"></div>

      <div class="hope-title">
        <div>
          <h1 id="appTitle">JAA Home Health Help Finder</h1>
          <p id="appSubtitle">Quick help for home health, hospice, transportation, benefits, and aging support.</p>

          <!-- Tabs -->
          <div class="tabs" role="tablist" aria-label="Audience Tabs">
            <button class="tab active" id="tab-patient" role="tab" aria-selected="true" onclick="setAudience('patient')">
              üßë‚Äçü¶≥ Patients <small>(default)</small>
            </button>
            <button class="tab" id="tab-staff" role="tab" aria-selected="false" onclick="setAudience('staff')">
              ü©∫ Staff
            </button>
            <button class="tab" id="tab-admin" role="button" aria-pressed="false" onclick="toggleAdmin()">
              üõ†Ô∏è Admin
            </button>

            <div class="admin-pill" id="adminPill">ADMIN MODE ON</div>
          </div>

          <!-- Share Link -->
          <div class="share-link" onclick="toggleQR()">üì≤ Share this page via QR</div>
        </div>

        <div class="badge">
          <div>Updated</div>
          <div id="updatedDate">‚Äî</div>
        </div>
      </div>

      <p class="muted-note" id="metaNotes"></p>
    </div>

    <!-- Icon Nav -->
    <div id="iconNav" class="icon-nav"></div>

    <div class="primary card">
      <div class="card-inner">
        <div class="label">Most important first step</div>
        <div class="callbox">
          <div class="call-left">
            <div class="big-name" id="primaryName">Loading‚Ä¶</div>
            <p class="small" id="primaryShort"></p>
            <div class="pill-row" id="primaryPills"></div>
          </div>

          <a class="call-btn" id="primaryCallBtn" href="#">
            ‚òéÔ∏è <span id="primaryPhone">‚Äî</span>
          </a>
        </div>
      </div>
    </div>

    <div id="sectionsRoot"></div>

    <!-- Admin footer (ONLY visible in Admin mode) -->
    <div class="admin-footer card" id="adminFooter">
      <div class="card-inner">
        <h3 style="margin:0;font-size:1rem;">Admin: Flag issues & email</h3>
        <p style="margin:6px 0 0;color:var(--muted);font-size:.92rem;line-height:1.35;">
          Use the checkboxes under each section to flag issues. This panel sends a summary email to
          <strong>jaadoc@gmail.com</strong>.
        </p>

        <div class="admin-actions-row">
          <button class="send-btn" onclick="sendAdminEmail()">üìß Send admin flags email</button>
          <button class="ghost-btn" onclick="clearAdminFlags()">Clear all flags</button>
          <div class="admin-status" id="adminStatus">Flags: 0</div>
        </div>
        <div class="fineprint" style="margin-top:10px;">
          Tip: Admin controls are hidden unless Admin mode is ON.
        </div>
      </div>
    </div>

    <div class="feedback card">
      <div class="card-inner">
        <h3>Help improve this tool</h3>
        <p>
          If something is wrong, outdated, or confusing, you can send feedback.
          <strong>This inbox is NOT checked for urgent help</strong> ‚Äî it‚Äôs only used to improve the system.
        </p>

        <div class="rate-row">
          <button class="rate-btn good" onclick="rate('GOOD')">‚úÖ Helpful</button>
          <button class="rate-btn meh" onclick="rate('MEH')">ü§î Okay / Meh</button>
          <button class="rate-btn bad" onclick="rate('BAD')">‚ö†Ô∏è Problematic</button>
        </div>

        <div class="why" id="whyBox">
          <textarea id="whyText" placeholder="Optional: what should be fixed? (wrong number, hours changed, unclear instructions, etc.)"></textarea>

          <div class="send-row">
            <button class="send-btn" onclick="sendFeedbackEmail()">Send feedback email</button>
            <div class="tiny" id="ratingStatus">Rating: ‚Äî</div>
          </div>

          <div class="fineprint">
            Sends to: <strong>jaadoc@upmc.edu</strong> (not monitored for urgent help).
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="qr-modal" id="qrModal" onclick="toggleQR()">
    <div class="qr-card" onclick="event.stopPropagation()">
      <h3 id="qrTitle">Share JAA Home Health</h3>
      <img id="qrImg" src="" alt="QR Code" />
      <button class="qr-close" onclick="toggleQR()">Close</button>
    </div>
  </div>

<script>
  let APP_DATA = null;
  let CURRENT_RATING = null;

  // Put these files next to jaa.html:
  //   - jaa_patient.json
  //   - jaa_staff.json
  const DATA_FILES = {
    patient: "./jaa_patient.json",
    staff: "./jaa_staff.json"
  };

  // Update if your GitHub Pages path changes
  const SHARE_BASE_URL = "https://dormantone.github.io/streetwise/jaa.html";

  let AUDIENCE = "patient";
  let ADMIN_MODE = false;

  // sectionId -> { html, phone, website, map, comment }
  const ADMIN_FLAGS = {};

  function safeText(s){ return (s ?? "").toString(); }

  function fmtPhoneForTel(phoneRaw){
    if(!phoneRaw) return "";
    return phoneRaw.replace(/\\s+/g,'');
  }

  function normalizeUrl(u){
    const s = safeText(u).trim();
    if(!s) return "";
    if(s.startsWith("http://") || s.startsWith("https://")) return s;
    return "https://" + s;
  }

  function hostLabel(url){
    try{
      const u = new URL(url);
      let h = u.hostname.replace(/^www\\./,'');
      return h;
    }catch(e){
      return url;
    }
  }

  // ====== Hope Animation: floating lights ======
  (function makeLights(){
    const holder = document.getElementById("lights");
    const n = 16;
    for(let i=0;i<n;i++){
      const d = document.createElement("div");
      d.className = "light";
      const left = Math.random()*100;
      const top = 60 + Math.random()*55;
      const dur = 5 + Math.random()*7;
      const delay = Math.random()*6;
      const size = 6 + Math.random()*10;

      d.style.left = left + "%";
      d.style.top = top + "%";
      d.style.animationDuration = dur + "s";
      d.style.animationDelay = delay + "s";
      d.style.width = size + "px";
      d.style.height = size + "px";
      d.style.opacity = 0.35 + Math.random()*0.35;
      holder.appendChild(d);
    }
  })();

  function makePills(tags){
    const wrap = document.createElement("div");
    wrap.className = "pill-row";
    (tags || []).slice(0,6).forEach(t=>{
      const p = document.createElement("div");
      p.className = "pill";
      p.textContent = t;
      wrap.appendChild(p);
    });
    return wrap;
  }

  function ensureAdminRecord(sectionId){
    if(!ADMIN_FLAGS[sectionId]){
      ADMIN_FLAGS[sectionId] = { html:false, phone:false, website:false, map:false, comment:"" };
    }
    return ADMIN_FLAGS[sectionId];
  }

  function updateAdminStatus(){
    let n = 0;
    for(const sid of Object.keys(ADMIN_FLAGS)){
      const r = ADMIN_FLAGS[sid];
      if(r.html || r.phone || r.website || r.map || (r.comment||"").trim()) n++;
    }
    const el = document.getElementById("adminStatus");
    if(el) el.textContent = "Flags: " + n;
  }

  function buildAdminPanel(section){
    const sectionId = safeText(section.id);
    const rec = ensureAdminRecord(sectionId);

    const panel = document.createElement("div");
    panel.className = "admin-panel";
    panel.setAttribute("data-section-id", sectionId);

    const title = document.createElement("div");
    title.className = "admin-title";
    title.innerHTML = `<strong>Admin check</strong><span>Section: ${sectionId}</span>`;
    panel.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "admin-grid";

    function mkChk(key, label){
      const wrap = document.createElement("label");
      wrap.className = "chk";
      const id = `adm_${sectionId}_${key}`;
      wrap.innerHTML = `<input type="checkbox" id="${id}"> <span>${label}</span>`;
      const cb = wrap.querySelector("input");
      cb.checked = !!rec[key];
      cb.addEventListener("change", ()=>{
        rec[key] = cb.checked;
        updateAdminStatus();
        saveAdminFlags();
      });
      return wrap;
    }

    grid.appendChild(mkChk("html", "Flag HTML issue"));
    grid.appendChild(mkChk("phone", "Flag phone number(s)"));
    grid.appendChild(mkChk("website", "Flag website link(s)"));
    grid.appendChild(mkChk("map", "Flag map/address"));

    const cWrap = document.createElement("div");
    cWrap.className = "admin-comment";
    const ta = document.createElement("textarea");
    ta.placeholder = "Admin comment (optional)";
    ta.value = rec.comment || "";
    ta.addEventListener("input", ()=>{
      rec.comment = ta.value;
      updateAdminStatus();
      saveAdminFlags();
    });
    cWrap.appendChild(ta);
    grid.appendChild(cWrap);

    panel.appendChild(grid);
    return panel;
  }

  function buildItemCard(item){
    const phone = safeText(item.display_phone || "");
    const tel = fmtPhoneForTel(item.phone || "");
    const website = normalizeUrl(item.website || "");

    const div = document.createElement("div");
    div.className = "item";

    const head = document.createElement("div");
    head.className = "item-head";

    const left = document.createElement("div");
    left.style.flex = "1 1 auto";
    left.style.minWidth = "0";

    const title = document.createElement("div");
    title.className = "item-title";
    title.textContent = safeText(item.name);

    const meta = document.createElement("div");
    meta.className = "item-meta";

    const lines = [];
    if(item.summary) lines.push(item.summary);
    if(item.address) lines.push("üìç " + item.address);
    if(item.hours) lines.push("üïí " + item.hours);
    if((item.tags || []).length) lines.push("üè∑Ô∏è " + item.tags.join(" ‚Ä¢ "));
    if(website) lines.push("üåê " + hostLabel(website));

    meta.textContent = lines.join("  |  ");

    left.appendChild(title);
    left.appendChild(meta);

    const actions = document.createElement("div");
    actions.className = "item-actions";

    if(tel){
      const callA = document.createElement("a");
      callA.className = "mini-btn primary";
      callA.href = "tel:" + tel;
      callA.innerHTML = "‚òéÔ∏è Call";
      callA.title = "Call " + phone;
      actions.appendChild(callA);
    }

    if(website){
      const webA = document.createElement("a");
      webA.className = "mini-btn web";
      webA.href = website;
      webA.target = "_blank";
      webA.rel = "noopener noreferrer";
      webA.innerHTML = "üåê Web";
      webA.title = "Open website";
      actions.appendChild(webA);
    }

    if(item.address){
      const mapsA = document.createElement("a");
      mapsA.className = "mini-btn";
      const q = encodeURIComponent(item.address);
      mapsA.href = "https://www.google.com/maps/search/?api=1&query=" + q;
      mapsA.target = "_blank";
      mapsA.rel = "noopener noreferrer";
      mapsA.innerHTML = "üó∫Ô∏è Map";
      mapsA.title = "Open in maps";
      actions.appendChild(mapsA);
    }

    head.appendChild(left);
    head.appendChild(actions);
    div.appendChild(head);

    // Collapsible details
    const det = document.createElement("details");
    const sum = document.createElement("summary");
    sum.textContent = "See more";

    const box = document.createElement("div");
    box.className = "details-box";

    const bits = [];
    if(phone) bits.push("Phone: " + phone);
    if(website) bits.push("Website: " + website);
    if(item.details) bits.push(item.details);

    const text = bits.filter(Boolean).join("\\n\\n");
    const urlRegex = /(https?:\\/\\/[^\\s]+)/g;
    box.innerHTML = text.replace(urlRegex, (m)=>`<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`);

    det.appendChild(sum);
    det.appendChild(box);
    div.appendChild(det);

    return div;
  }

  function buildSection(section){
    const container = document.createElement("div");
    container.className = "section card";
    container.id = "sec-" + section.id;

    const inner = document.createElement("div");
    inner.className = "card-inner";

    const h2 = document.createElement("h2");
    h2.textContent = section.title;

    inner.appendChild(h2);

    (section.items || []).forEach(item=>{
      inner.appendChild(buildItemCard(item));
    });

    // Admin panel under each section (only visible when Admin mode on)
    inner.appendChild(buildAdminPanel(section));

    container.appendChild(inner);
    return container;
  }

  function renderAll(){
    const root = document.getElementById("sectionsRoot");
    root.innerHTML = "";
    if(!APP_DATA) return;

    const sections = [...(APP_DATA.sections || [])]
      .sort((a,b)=>(a.importance||999)-(b.importance||999));

    sections.forEach(sec=>{
      root.appendChild(buildSection(sec));
    });

    // In case flags were loaded from storage
    updateAdminStatus();
  }

  function fillHeader(){
    document.getElementById("appTitle").textContent = safeText(APP_DATA?.meta?.title || "JAA Home Health Help Finder");
    document.getElementById("appSubtitle").textContent = safeText(APP_DATA?.meta?.subtitle || "");
    document.getElementById("updatedDate").textContent = safeText(APP_DATA?.meta?.updated || "‚Äî");

    const notes = (APP_DATA?.meta?.notes || []).map(x=>"‚Ä¢ " + x).join("  ");
    document.getElementById("metaNotes").textContent = notes;

    const pc = APP_DATA?.primary_contact;
    if(pc){
      document.getElementById("primaryName").textContent = safeText(pc.name);
      document.getElementById("primaryShort").textContent = safeText(pc.short);

      const phone = safeText(pc.display_phone || "");
      const tel = fmtPhoneForTel(pc.phone || "");
      const btn = document.getElementById("primaryCallBtn");
      btn.href = tel ? ("tel:" + tel) : "#";
      document.getElementById("primaryPhone").textContent = phone || "Call";

      const pillHost = document.getElementById("primaryPills");
      pillHost.innerHTML = "";
      pillHost.appendChild(makePills(AUDIENCE === "staff"
        ? ["Referrals", "Coordination", "Wraparound services"]
        : ["Home health intake", "Skilled care", "Support services"]
      ));
    }
  }

  // ===== Feedback flow =====
  function rate(val){
    CURRENT_RATING = val;
    document.getElementById("whyBox").style.display = "grid";
    document.getElementById("ratingStatus").textContent = "Rating: " + val;
    setTimeout(()=>document.getElementById("whyText").focus(), 50);
  }

  function sendFeedbackEmail(){
    const why = (document.getElementById("whyText").value || "").trim();

    const subject = `JAA Home Health Help Finder feedback ‚Äî ${CURRENT_RATING || "UNSET"} (${AUDIENCE})`;
    const bodyLines = [
      "Feedback on the JAA Home Health Help Finder tool",
      "",
      "Audience tab: " + AUDIENCE,
      "Rating: " + (CURRENT_RATING || "UNSET"),
      "",
      "Why / Notes:",
      why || "(no additional details provided)",
      "",
      "Reminder: this inbox is NOT monitored for urgent help.",
      "It is used only to improve the tool.",
      "",
      "Sent from the web page."
    ];

    const mailto = `mailto:jaadoc@upmc.edu?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyLines.join("\\n"))}`;
    window.location.href = mailto;
  }

  // ===== Admin Mode =====
  function setAdmin(on){
    ADMIN_MODE = !!on;
    localStorage.setItem("jaa_admin", ADMIN_MODE ? "1" : "0");
    document.body.classList.toggle("admin-on", ADMIN_MODE);

    const btn = document.getElementById("tab-admin");
    if(btn){
      btn.classList.toggle("active", ADMIN_MODE);
      btn.setAttribute("aria-pressed", ADMIN_MODE ? "true" : "false");
    }

    const footer = document.getElementById("adminFooter");
    if(footer) footer.style.display = ADMIN_MODE ? "block" : "none";

    updateAdminStatus();
  }

  function toggleAdmin(){
    setAdmin(!ADMIN_MODE);
  }

  function adminStorageKey(){
    return "jaa_admin_flags__" + AUDIENCE;
  }

  function saveAdminFlags(){
    try{
      localStorage.setItem(adminStorageKey(), JSON.stringify(ADMIN_FLAGS));
    }catch(e){}
  }

  function loadAdminFlags(){
    try{
      const raw = localStorage.getItem(adminStorageKey());
      if(!raw) return;
      const parsed = JSON.parse(raw);
      if(parsed && typeof parsed === "object"){
        for(const k of Object.keys(parsed)){
          const v = parsed[k];
          ADMIN_FLAGS[k] = {
            html: !!v.html,
            phone: !!v.phone,
            website: !!v.website,
            map: !!v.map,
            comment: safeText(v.comment || "")
          };
        }
      }
    }catch(e){}
  }

  function clearAdminFlags(){
    for(const k of Object.keys(ADMIN_FLAGS)){
      delete ADMIN_FLAGS[k];
    }
    saveAdminFlags();
    renderAll(); // re-render to reset checkboxes/comments
  }

  function sendAdminEmail(){
    // Build summary from flags
    const parts = [];
    const now = new Date();
    parts.push("Admin flags for JAA Home Health Help Finder");
    parts.push("");
    parts.push("Audience dataset: " + AUDIENCE);
    parts.push("Timestamp: " + now.toISOString());
    parts.push("Page: " + window.location.href);
    parts.push("");

    const flagged = [];
    for(const sec of (APP_DATA?.sections || [])){
      const sid = safeText(sec.id);
      const r = ADMIN_FLAGS[sid];
      if(!r) continue;
      const hasAny = r.html || r.phone || r.website || r.map || (r.comment||"").trim();
      if(!hasAny) continue;

      const issues = [];
      if(r.html) issues.push("HTML");
      if(r.phone) issues.push("Phone");
      if(r.website) issues.push("Website");
      if(r.map) issues.push("Map");

      flagged.push({
        title: safeText(sec.title),
        id: sid,
        issues,
        comment: safeText(r.comment || "").trim()
      });
    }

    if(flagged.length === 0){
      alert("No admin flags yet. Check a box under a section first.");
      return;
    }

    parts.push("Flagged sections:");
    parts.push("");

    flagged.forEach((f, idx)=>{
      parts.push((idx+1) + ") " + f.title + "  [" + f.id + "]");
      parts.push("   Issues: " + (f.issues.length ? f.issues.join(", ") : "(none)"));
      if(f.comment) parts.push("   Comment: " + f.comment);
      parts.push("");
    });

    const subject = `JAA Admin Flags (${AUDIENCE}) ‚Äî ${flagged.length} section(s)`;
    const mailto = `mailto:jaadoc@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(parts.join("\\n"))}`;
    window.location.href = mailto;
  }

  // ===== Icons for your sections =====
  const SECTION_ICONS = {
    "immediate": "üÜò",
    "transportation": "üöê",
    "care": "üß≠",
    "ltss": "üßæ",
    "home_health": "üè•",
    "hospice": "üïäÔ∏è",
    "adult_day": "üèõÔ∏è",
    "food": "üçΩÔ∏è",
    "benefits": "üíä",
    "legal": "‚öñÔ∏è",
    "financial": "üí°",
    "home_safety": "üõ†Ô∏è",
    "facilities": "üè©",
    "inhome_private": "üßë‚Äç‚öïÔ∏è"
  };

  function speakLabel(text) {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = 1.08;
      window.speechSynthesis.speak(utter);
    }
  }

  function renderIconNav() {
    if (!APP_DATA || !APP_DATA.sections) return;
    const nav = document.getElementById("iconNav");
    nav.innerHTML = "";

    APP_DATA.sections.forEach(sec => {
      const btn = document.createElement("div");
      btn.className = "icon-btn";

      const iconChar = SECTION_ICONS[sec.id] || "üìå";

      const emoji = document.createElement("div");
      emoji.className = "icon-btn-emoji";
      emoji.textContent = iconChar;

      const lbl = document.createElement("div");
      lbl.className = "icon-btn-label";
      lbl.textContent = sec.title.split("(")[0].trim();

      btn.appendChild(emoji);
      btn.appendChild(lbl);

      btn.onclick = () => {
        speakLabel(sec.title);
        const target = document.getElementById("sec-" + sec.id);
        if(target) target.scrollIntoView({behavior: "smooth", block: "start"});
      };

      nav.appendChild(btn);
    });
  }

  // ===== QR Modal Toggle =====
  function getShareUrl(){
    const u = new URL(SHARE_BASE_URL);
    u.searchParams.set("audience", AUDIENCE);
    return u.toString();
  }

  function updateQR(){
    const shareUrl = getShareUrl();
    document.getElementById("qrTitle").textContent =
      AUDIENCE === "staff" ? "Share JAA Home Health (Staff)" : "Share JAA Home Health (Patients)";
    document.getElementById("qrImg").src =
      "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(shareUrl);
  }

  function toggleQR() {
    updateQR();
    const m = document.getElementById("qrModal");
    m.classList.toggle("active");
  }

  // ===== Audience Tabs =====
  function setTabUI(){
    const p = document.getElementById("tab-patient");
    const s = document.getElementById("tab-staff");
    const isStaff = AUDIENCE === "staff";

    p.classList.toggle("active", !isStaff);
    s.classList.toggle("active", isStaff);

    p.setAttribute("aria-selected", (!isStaff).toString());
    s.setAttribute("aria-selected", (isStaff).toString());
  }

  function setAudience(a){
    AUDIENCE = (a === "staff") ? "staff" : "patient";
    localStorage.setItem("jaa_audience", AUDIENCE);

    const url = new URL(window.location.href);
    url.searchParams.set("audience", AUDIENCE);
    history.replaceState({}, "", url.toString());

    // load the right flag store for this dataset
    for(const k of Object.keys(ADMIN_FLAGS)){ delete ADMIN_FLAGS[k]; }
    loadAdminFlags();

    setTabUI();
    load();
  }

  function getInitialAudience(){
    const url = new URL(window.location.href);
    const qp = (url.searchParams.get("audience") || "").toLowerCase().trim();
    if(qp === "staff" || qp === "patient") return qp;
    const saved = (localStorage.getItem("jaa_audience") || "").toLowerCase();
    if(saved === "staff" || saved === "patient") return saved;
    return "patient";
  }

  function getInitialAdmin(){
    const url = new URL(window.location.href);
    const qp = (url.searchParams.get("admin") || "").toLowerCase().trim();
    if(qp === "1" || qp === "true" || qp === "yes") return true;
    return (localStorage.getItem("jaa_admin") === "1");
  }

  // ===== Load JSON =====
  async function load(){
    try{
      const file = DATA_FILES[AUDIENCE] || DATA_FILES.patient;

      // Friendly warning if opening as file://
      if(window.location.protocol === "file:"){
        console.warn("Opened via file:// ‚Äî browser may block fetch(). Use a local server or GitHub Pages.");
      }

      const resp = await fetch(file, {cache: "no-store"});
      if(!resp.ok) throw new Error("Could not load " + file);
      APP_DATA = await resp.json();

      fillHeader();
      renderAll();
      renderIconNav();
    } catch(err){
      console.error(err);
      document.getElementById("primaryName").textContent = "Could not load data file";
      const hint = (window.location.protocol === "file:")
        ? "You opened jaa.html directly. Browsers often block JSON fetch on file://. Run: python3 -m http.server 8000, then open http://localhost:8000/jaa.html"
        : "Make sure jaa.html and jaa_patient.json / jaa_staff.json are in the same folder.";
      document.getElementById("primaryShort").textContent = hint;
    }
  }

  // Init
  AUDIENCE = getInitialAudience();
  ADMIN_MODE = getInitialAdmin();

  loadAdminFlags();
  setTabUI();
  setAdmin(ADMIN_MODE);
  load();
</script>
</body>
</html>
